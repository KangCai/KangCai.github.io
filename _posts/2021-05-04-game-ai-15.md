---
layout: post
title: "游戏 AI - A611"
subtitle: "路径策略"
author: "Kang Cai"
header-img: "img/post-bg-dreamer.jpg"
header-mask: 0.4
tags:
  - 游戏 AI
---

路径点是游戏关卡中的一个单一位置，寻路使用节点作为通过关卡的路径的中间点，这就是路点的最初用途，本节中的技术自然地从扩展寻路所需的数据发展而来，从而允许进行其他类型的决策。

当我们在寻路中使用路点时，它们表示寻路图中的节点，以及算法所需的相关数据:连接、量化区域、成本等等。要在战术上使用路点，我们需要向节点添加更多数据，而我们存储的数据将取决于我们使用路点的目的。

在本节中，我们将研究如何使用路径点来代表关卡中不同寻常的战术特性，这样，一个占据该位置的角色将会利用该战术特性。首先，我们将考虑由游戏设计者设置位置和战术信息的路点。然后，我们会看看如何推断首先是战术信息，然后自动位置。

## 一、战术位置

用于描述战术位置的路点有时也被称为集结点。它们早期在模拟(特别是军事模拟)中的一个用途是标记一个固定的安全位置，在失败的交火中，一个角色可以撤退到那里。同样的原理也适用于现实世界的军事规划；当一个排与敌人交战时，它至少会有一个预先决定好的安全撤退点，如果战术情况需要，它可以撤退到那里。通过用这种方法，失败的战斗并不总是导致溃败。

在游戏中更常见的是使用战术位置来代表防守位置或掩护点。在游戏的静态区域，设计师通常会在桶或突出的墙壁后面标记位置作为良好的掩蔽点。当一个角色与敌人交战时，它会移动到最近的掩蔽点，为自己提供一些掩蔽处。

还有其他一些受欢迎的战术地点。狙击手的位置对部队的射手来说尤为重要。关卡设计者会标记适合狙击手的位置，然后拥有远程武器的角色可以前往那里寻找掩护并接近敌人。

在潜行游戏中，也需要给秘密移动的角色一组有强烈阴影的位置。它们的运动可以通过在阴影区域之间移动来控制，只要敌人的视锥被转移(实现感官感知在第11章，世界接口中有介绍)。

使用路点来表示战术信息有无限种不同的方法。我们可以标记可以形成大量火力的火力点，可以恢复状态的恢复点，可以进行大面积侦察的瞭望点，角色如果发现可以进行逃脱的快速退出点，等等。战术点甚至可以是要避免的位置，如伏击热点、暴露区域或下沉的沙子。

根据你所创造的游戏类型，你的角色可以遵循几种策略。对于每一种战术，游戏中可能都有相应的战术位置，积极的(帮助战术的位置)或消极的(阻碍战术的位置)。

### 1.1 一组位置集合

大多数使用战术位置的游戏并不局限于一种或另一种类型。游戏关卡包含了大量的路径点，每个路径点都有自己的战术特性。如果路点也用于寻路，那么它们也将具有寻路数据，例如连接和区域。

实际上，作为寻路图的一部分，掩蔽点和狙击火力的位置并不是很有用。图6.2说明了这种情况。虽然是最常见的组合锚点的两组,它可以提供更高效的寻路有一个单独的寻路图和战术位置。你将不得不这样做,当然,如果你是使用不同的方法代表了寻路图,如导航网格或tilebased世界。

在本节的大部分时间里，我们将假设我们感兴趣的位置并不一定是寻路图的一部分。稍后，我们将看到一些情况，将两者合并在一起可以提供非常强大的行为，几乎不需要额外的努力。然而，通常没有理由将这两种技术联系起来。

<img src="https://kangcai.github.io/img/in-post/post-gameai/A611.0.PNG"/>

图6.2显示了游戏关卡中一个区域的一组典型战术位置。它结合了三种战术位置:掩蔽点、阴影点和狙击点。有些点有不止一个战术属性。例如，大多数阴影点也是掩蔽点。在这些位置中只有一个战术位置，但它同时具有这两种属性。

标记所有有用的位置可以在关卡中产生大量的路径点。为了获得高质量的行为，这对于关卡设计师来说是必要的，但却很耗费时间。在本节的后面，我们将介绍一些自动生成路点数据的方法。

### 1.2 基础战术和复合战术

在大多数游戏中，拥有一套预定义的战术特性(比如狙击手、阴影、掩护等等)就足以支持有趣而智能的战术行为。我们将在本节稍后看到的算法基于这些固定的类别做出决策。

然而，我们可以使模型更加复杂。当我们观察狙击手的位置时，我提到过狙击手的位置会有很好的掩护并且能提供广阔的视野。我们可以把它分解成两个独立的要求:掩护和监视敌人。如果我们在游戏中同时支持掩蔽点和高可见度点，我们就不需要指定好的狙击手位置。我们可以简单地说狙击手的位置是那些同时是掩蔽点和侦察点的点。狙击手的位置有一个复合战术
质量;它们是由两种或更多的原始战术组成的。

我们也不需要将自己限制在具有两个属性的单一位置。当一个角色在交火中处于攻势时，它需要找到一个很好的掩蔽点，非常靠近一个能提供清晰火力的位置。角色可以躲进掩蔽点去重新装弹，或者当攻击火力特别密集的时候，然后跳出掩蔽点去攻击敌人。我们可以指定一个防御性的掩蔽点是一个火力非常接近的掩蔽点(通常在侧身滚动的半径内:进入和离开掩蔽点的典型动画)。

同样地，如果我们在寻找伏击的好地点，我们可以寻找附近有好的隐藏地点的暴露地点。好的藏身之处是他们自己的复合战术，结合好的掩蔽和阴影。

<img src="https://kangcai.github.io/img/in-post/post-gameai/A611.1.PNG"/>

图6.3显示了一个示例。在走廊上，标出掩蔽点、阴影点和暴露点。我们认为一个好的伏击点是一个有掩护和阴影，靠近暴露点。如果敌人移动到暴露点，并且有一个人物处于阴影中，那么它将很容易受到攻击。好的伏击点在图中标示出来。

我们可以利用这些复合策略，只存储原始的品质。在上面的例子中，我们存储了三个战术特性:掩护、阴影和暴露。通过这些，我们可以计算出放置或避免埋伏的最佳地点。通过限制的数量不同的战术品质，我们可以支持大量不同的战术，而不会让关卡设计师的工作变得不可能，也不会让内存中充斥着很少需要的路点数据。另一方面，我们在记忆中得到的，我们在速度中失去的。为了找出最近的伏击点，我们需要在阴影中寻找掩蔽点，然后检查每一个附近的暴露点，以确保它在我们寻找的半径内。

在绝大多数情况下，这种额外处理并不重要。例如，如果一个角色需要找到一个埋伏的位置，那么他可能需要思考好几个帧。基于战术位置的决策并不是每个角色都需要做的事情，所以对于合理数量的角色来说，时间并不是最重要的。

但是，对于很多角色或者条件集非常复杂的情况，路径点集可以离线进行预处理，所有的复合质量都可以被识别出来。这并不会在游戏运行时节省内存，但却可以让关卡设计师不需要指定每个位置的所有属性。这可以更进一步，我们甚至可以使用算法来检测原始的质量。在本节的后面，我将回到自动检测原始质量的算法。

### 1.3 路径点图和拓扑分析

到目前为止，我所描述的路径点都是独立的、孤立的位置。没有关于一个路径点是否可以从另一个路径点到达的信息。我在本节开始时提到了寻路图中路径点与节点的相似性。我们当然可以在寻路图中使用节点作为战术位置(尽管它们并不总是最合适的，我们将在后面关于战术寻路的章节6.3中看到)。

但即使我们不使用寻路图，我们也可以将战术位置连接起来，从而获得更复杂的复合战术。

让我们假设我们正在寻找一个提供一个好的位置来进行攻击。图6.4中的路点集显示了需要考虑的级别的一部分。当一个可以从另一个直接到达时，路点是连接的。例如，没有穿过墙的连接。在阳台上，我们有一个可以看到房间的位置，一个攻击点的候选位置。类似地，在一个小接待室(B)的另一个位置可能是有用的。

阳台显然比前厅好，因为它有三个出口，只有一个出口通向房间。如果我们想实施打了就跑的攻击，那么我们需要找到能见度好的位置，但有很多出口路线。

这是一个拓扑分析。它通过观察路点图的属性来推断层的结构。这是一种复合战术，但它利用了路径点之间的联系以及它们的战术素质和位置。

拓扑分析可以使用寻路图进行，也可以在基本的战术路径点上进行。不过，它确实需要在路点之间建立连接。如果没有这些连接，我们就不知道附近的路点是否构成了出口路，或者它们之间是否有一堵墙。

<img src="https://kangcai.github.io/img/in-post/post-gameai/A611.2.PNG"/>

不幸的是，这种拓扑分析可能很快变得复杂起来。它对路径点的密度非常敏感。以图6.4中的位置C为例。同样，射击姿势有三条出口。然而，在这种情况下，它们都通向附近的同一地点，立即逃跑。角色在寻找一个良好的命中和逃跑位置的基础上单独的出口数量可能会错误地发动它的攻击在房间的中间。

当然，我们可以使拓扑分析算法更加复杂。我们不仅可以看到连接的数量，还可以看到这些连接通向哪里，等等。

根据我的经验，这种分析的复杂性令人生畏，超出了大多数开发人员想要花时间实现和调整的范围。在我看来，开发一个全面的拓扑分析系统和让关卡设计师简单地指定适当的战术位置之间并没有太多的争论。除了最简单的分析之外，关卡设计师每次都能获得工作。

自动拓扑分析不时出现在书籍和论文中。我的建议是要谨慎对待它，除非你能腾出几个月的时间来把它做好。从长远来看，手动操作的方法通常不那么痛苦。

### 1.4 连续策略

为了支持更复杂的复合策略，我们可以远离简单的布尔状态。例如，我们可以为每个位置提供一个数值，而不是将一个位置标记为遮蔽或阴影。一个路径点会有一个遮蔽值和一个不同的阴影值。

这些值的意义将取决于游戏，它们可以有任何方便的范围。然而，为了清晰起见，我们假设这些值是范围(0,1)内的浮点数，其中1表示路径点具有一个属性的最大数量(例如覆盖或阴影的最大数量)。

就其本身而言，我们可以使用这些信息来简单地比较路径点的质量。如果一个角色试图寻找掩蔽点，并且在掩蔽= 0.9或掩蔽= 0.6的路径点之间有相同的选择，那么他应该选择掩蔽= 0.9的路径点。

我们也可以将这些值解释为一个模糊集的隶属度(模糊逻辑的基础在第5章，决策制定中有描述)。当路径点的覆盖度为0.9时，它在覆盖点集合中具有较高的隶属度。

将值解释为隶属度允许我们使用模糊逻辑规则为复合策略生成值。回想一下，我们将狙击手的位置定义为一个既能看到敌人又能有良好掩护的路径点。换句话说

```
sniper = cover AND visibility
``` 

如果我们有一个路径点，覆盖= 0.9，可见性= 0.7，我们可以使用模糊规则

<img src="https://kangcai.github.io/img/in-post/post-gameai/A611.3.PNG"/>

mA和mB是A和b的隶属度加上我们得到的数据

<img src="https://kangcai.github.io/img/in-post/post-gameai/A61.4.PNG"/>

所以我们可以推导出狙击手位置的质量，并以此作为一个角色战术行动的基础。这个示例非常简单，仅仅使用 AND 来组合其组件。正如我们在上一节看到的，我们可以为复合战术设计相当复杂的条件。将这些值解释为模糊状态下的隶属度，使我们能够处理由许多子句组成的最复杂的定义。它提供了一种经过尝试和测试的机制，以获得可靠的值。

使用这种方法的缺点是每个路径点需要为其存储一组完整的值。如果我们要跟踪5个不同的战术属性，那么对于非数字的情况，我们只需要在每个集合中保留一个路径点列表。另一方面，如果我们为每个路径点存储一个数字值，那么每个路径点将有5个数字。

我们可以稍微减少需要存储不存储零值,尽管这使得事情更加复杂,因为我们需要一个可靠的方式来存储这个值的价值和意义(如果我们总是存储五个数字,我们可以告诉每个数字意味着什么立场的数组)。

对于大型户外世界，比如那些用于即时战略(RTS)或大型多人游戏的世界，我们可能需要节省内存。然而，在大多数射击游戏中，额外的内存不太可能造成问题。

### 1.5 上下文敏感度

然而，用我目前所描述的方式标记战术位置仍然存在一个问题。一个地点的战术属性几乎总是对角色的动作或游戏的当前状态非常敏感。

例如，躲在枪管后面，只有当角色蹲伏时才会有掩护。如果角色站在枪管后面，那么枪管就很容易受到攻击。同样，如果敌人在你身后，躲在突出的岩石后面是没有用的。目标是把岩石之间的角色和来袭的火。

这个问题不仅仅局限于覆盖点。本节中的任何战术位置在某些情况下都可能无效。如果敌人成功地发动了侧翼进攻，那么向敌人后方撤退是没有用的。

有些战术位置的情况甚至更为复杂。如果每个人都知道狙击手驻扎在那里，那么狙击点很可能毫无用处。除非它是一个无法穿透的藏身之处(我认为这是一个错误的关卡设计的标志)，那么狙击手的位置在某种程度上依赖于秘密。

实现上下文敏感性有两种选择。首先，我们可以为每个节点存储多个值。例如，一个隐蔽路径点可能有四个不同的方向。对于任何给定的掩蔽点，只有其中的一些方向被覆盖。这四个方向是路径点的状态。对于保险来说，我们有四个状态，每个状态对于保险的质量可能有一个完全独立的值(或者如果我们不使用连续策略值，则只是一个不同的yes/no值)。我们可以用任意数量的状态。例如，我们可能会有一个额外的状态来规定角色是否需要躲避以获得掩护，或者有额外的状态来规定不同的敌人武器;一个提供小武器火力掩护的位置可能不能保护其居民免受RPG的攻击。

对于那些状态集非常明显的战术，例如掩蔽点或射击点(我们可以再次使用四个方向作为射击弧线)，这是一个很好的解决方案。对于其他类型的上下文敏感性，则比较困难。在我们关于撤退地点的例子中，如何为敌人控制的领土指定一组合理的不同国家并不明显。

第二种方法是每个路径点只使用一种状态，正如我们在本节中看到的那样。我们没有将此值作为关于路径点战术质量的最终真相，而是添加了一个额外的步骤来检查它是否合适。这个检查步骤可以包括针对游戏状态的任何检查。在封面的例子中，我们可以检查我们的敌人的视线。在撤退的例子中，我们可以查看影响图(见本章后面6.2.2的影响图)，看看该位置目前是否在敌人的控制之下。

在狙击手的例子中，我们可以简单地保留一个布尔标志列表来跟踪敌人是否向狙击手的位置射击(一个简单的启发式，如果敌人知道这个位置在那里)。这个后处理步骤与用于自动生成路径点的战术属性的处理有相似之处。稍后我将回到这些技术。

作为每种方法的一个例子，考虑一个角色需要选择一个掩蔽点来在交火中重新加载。它可以从附近的两个覆盖点进行选择，如图6.5所示。

<img src="https://kangcai.github.io/img/in-post/post-gameai/A611.5.PNG"/>

在图6.5左边的图中，四个方向的覆盖点都显示了它们的覆盖质量。角色确定每个敌人的方向，并决定它需要从南方和东方方向的掩护。所以字符会检查提供这个的掩护点。覆盖点B有，它选择这个点。

在图6.5右边的图中，使用了一个运行时检查。角色检查两个掩蔽点对两个敌人的视线范围。它决定了掩蔽点B对敌人也没有视线，所以最好是对一个敌人有视线的掩蔽点a。

这两种方法之间的权衡是在质量、内存和执行速度之间。每个路径点使用多个状态可以快速做出决策。我们不需要在比赛中执行任何战术计算。我们只需要弄清楚我们对哪个州感兴趣。另一方面，为了得到高质量的策略，我们可能需要大量的州。如果我们需要四个方向的掩护，不管是站着还是蹲着，对抗五种不同类型的武器，我们需要40个州作为掩护的路径点。显然,这
会很快变得太多。

执行运行时检查给了我们更多的灵活性。它允许角色利用环境中的怪癖。掩蔽点可能不能向北提供掩护，除非受到特定通道的攻击(例如，屋顶梁的位置提供了掩护)。如果敌人在那条通道上，那么掩护点就是有效的。使用一个简单的状态作为掩护来抵御北方的攻击是不允许角色利用这一点的。

另一方面，运行时检查需要时间，特别是当我们在关卡几何中做大量的视线检查时。在战术复杂的游戏中，视线检查可能占据了游戏中使用的大部分AI时间:在我所熟悉的一种情况下，超过30%的处理器时间。如果你有很多角色需要对不断变化的战术情况做出快速反应，这可能是不可接受的。如果角色能够花几秒钟的时间来衡量他们的选择，那么你就可以在多个帧上进行这些检查，这不大可能成为问题。

在我看来，只有针对那些真正从良好的战术发挥中受益的核心玩家的游戏，如基于队的射手游戏，才需要运行时检查方法。对于其他不以战术为重点的游戏，少量的状态就足够了。在同一个游戏中可以结合这两种方法，多个状态提供一个过滤机制，以减少需要视线检查的不同掩护路径点的数量。

### 小结

我们已经考虑了一系列战术路径点的复杂性，从一个位置的战术质量的简单标签到基于模糊逻辑的复合的、上下文敏感的战术。实际上，大多数游戏并不需要走完整条路。

许多游戏可以通过简单的战术标签。如果这会产生奇怪的行为，那么下一个阶段实现的是上下文敏感性，这将大大提高人工智能的能力。

接下来，我建议添加连续的战术值，并允许角色基于路点的质量做出决定。

对于高度战术游戏来说，战术玩法的质量是游戏的卖点，使用复合战术(带有模糊逻辑)可以让你在不添加或更改关卡设计师需要创建的信息的情况下支持新的战术。到目前为止，我还没有做过这么远的游戏，尽管它在军事模拟领域并不新鲜。到目前为止，我们已经看到了游戏关卡是如何通过战术路径点来增强的。然而，就其本身而言，它们只是价值。我们需要一些机制将他们的数据纳入决策。